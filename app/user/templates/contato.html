{% load crispy_forms_tags %}
{% load static %} <!-- Add this line to load static files -->

<!DOCTYPE html>
<html lang="pt-br">

<head>
  <title>Cesium 3D Map</title>
  <!-- Include CesiumJS (CDN or local) -->
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.105/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.105/Build/Cesium/Cesium.js"></script>
  <style>
    #cesiumContainer {
      width: 100%;
      height: 100vh;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
  </style>
</head>

<body>
  {{ dados_por_ano_json|json_script:"id_dados_por_ano" }}
  <div id="cesiumContainer"></div>


  <script>
    /**
     * Remove acentos e converte para minÃºsculas.
     * Ex: "SÃ£o SepÃ©" -> "sao sepe"
     */
    function normalizarString(texto) {
      if (!texto) return ""; // ProteÃ§Ã£o contra nulos

      return texto
        .toLowerCase()
        .normalize("NFD") // Separa os acentos das letras
        .replace(/[\u0300-\u036f]/g, ""); // Remove os acentos
    }

    (async function () {
      // --- 1. DefiniÃ§Ã£o de Cores ---
      // Mapeamento de 'classificacao' para uma cor
      const coresPorClassificacao = {
        'Abaixo do Previsto': Cesium.Color.GREEN.withAlpha(0.7),
        'Acima do Previsto': Cesium.Color.RED.withAlpha(0.7),
        'Dentro do Previsto': Cesium.Color.BLUE.withAlpha(0.7),
        'PADRAO': Cesium.Color.GRAY.withAlpha(0.2) // âœ… CORRIGIDO: Adicionada cor padrÃ£o
      };

      // --- 2. Carregar Dados do Django ---
      const dadosElement = document.getElementById('id_dados_por_ano');
      const jsonString = dadosElement.textContent;
      const dadosPorAno2 = JSON.parse(jsonString)
      const dadosPorAno = JSON.parse(dadosPorAno2); // Renomeei para 'dadosPorAno' para clareza

      // LOG CORRIGIDO: Verifique os dados *depois* de carregÃ¡-los

      // --- 3. OtimizaÃ§Ã£o: Criar um Mapa de Consulta (Lookup Map) ---
      // Isso transforma sua lista de dados em um objeto de consulta rÃ¡pida.
      // Em vez de percorrer a lista para cada municÃ­pio, a consulta Ã© instantÃ¢nea.

      const anoSelecionado = '2023'; // ðŸ‘ˆ Defina qual ano vocÃª quer exibir
      const mapaClassificacao = new Map(); // Um mapa para consulta rÃ¡pida

      if (dadosPorAno[anoSelecionado]) {
        for (const item of dadosPorAno[anoSelecionado]) {
          const municipioNormalizado = normalizarString(item.municipio);
          
          if (municipioNormalizado) {
            mapaClassificacao.set(municipioNormalizado, item.classificacao);
          }
          else {
            // Opcional: avisa no console que um dado foi ignorado
            console.warn("Item ignorado (municÃ­pio nulo ou vazio):", municipioNormalizado);
          }
        }
        console.log(`Mapa de consulta para ${anoSelecionado}:`, mapaClassificacao);
      } else {
        console.warn(`Nenhum dado encontrado para o ano ${anoSelecionado}`);
      }

      // --- 4. Configurar o Cesium Viewer ---
      Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJkMGY4OWI4YS0xYmU3LTQ3YzctODI5NS1jZjE5NzBkZWE3ZjQiLCJpZCI6MTg4MjYzLCJpYXQiOjE3NDgxNDc1NDR9.Wpho5xiVB2HITQsLdzbNvhOnY7iVWbpQwTfgwzB2rc0';
      const terrainProvider = await Cesium.createWorldTerrainAsync();

      const viewer = new Cesium.Viewer('cesiumContainer', {
        terrainProvider,
        infoBox: false,
        selectionIndicator: false
      });

      // --- 5. Carregar e Processar o GeoJSON ---
      const geojsonUrl = "{% static 'user/geojson/tfg_oficial.geojson' %}";

      Cesium.GeoJsonDataSource.load(geojsonUrl)
        .then(dataSource => {
          viewer.dataSources.add(dataSource);
          viewer.zoomTo(dataSource);

          const entities = dataSource.entities.values;

          // Loop principal para colorir CADA entidade
          for (let i = 0; i < entities.length; i++) {
            const entity = entities[i];
            const nmMunProperty = entity.properties['NM_MUN'];

            if (nmMunProperty && entity.polygon) {
              
              // âœ… LINHA CORRIGIDA: Use a normalizaÃ§Ã£o aqui tambÃ©m
              const nmMun = normalizarString(nmMunProperty.getValue());
              
              // âœ… LÃ“GICA PRINCIPAL:
              // 1. Consulta o nome do municÃ­pio no nosso Mapa de ClassificaÃ§Ã£o
              const classificacao = mapaClassificacao.get(nmMun); // Ex: 'dentro do previsto' ou undefined

              
              if (classificacao) {
                // Encontrou uma classificaÃ§Ã£o, usa a cor correspondente
                entity.polygon.material = coresPorClassificacao[classificacao] || coresPorClassificacao['PADRAO'];
              } else {
                // NÃ£o encontrou classificaÃ§Ã£o para este municÃ­pio
                entity.polygon.material = coresPorClassificacao['PADRAO'];
                // console.log(`MunicÃ­pio "${nmMun}" nÃ£o encontrado nos dados do ano ${anoSelecionado}.`); // Descomente para debugar
              }

              // Define a borda (opcional)
              entity.polygon.outline = true;
              entity.polygon.outlineColor = Cesium.Color.BLACK.withAlpha(0.6);
            }
          }
        })
        .catch(error => {
          console.error('Falha ao carregar GeoJSON:', error);
        });
    })();
  </script>
</body>

</html>